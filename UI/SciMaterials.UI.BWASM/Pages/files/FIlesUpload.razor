@page "/files_upload"

@using SciMaterials.UI.BWASM.States.FileUpload
@using SciMaterials.UI.BWASM.Dialogs
@using SciMaterials.UI.BWASM.States.Categories
@using System.Text.Json
@using SciMaterials.UI.BWASM.States.Authors

@inherits FluxorComponent

@inject IDispatcher Dispatcher
@inject IState<FilesUploadState> State
@inject IState<FilesContentTypesFilterState> ContentTypesState
@inject IDialogService DialogService

<MudDrawerContainer>
	<MudDrawer @bind-Open="@_openFileDetails" Width="300px" Anchor="Anchor.Right" Variant="@DrawerVariant.Persistent">
		<MudIconButton Variant="Variant.Filled" Size="Size.Medium" Icon="@Icons.Material.Filled.Close" OnClick="CloseFileDetails" />
		
		<MudForm Model="@_formModel" @bind-IsValid="@_fileDetailsFormFilledCorrectly" @bind-Errors="@_fileDetailsFormError">
			<MudTextField T="string" Label="FileName"
			              @bind-Value="@_formModel.FileName"
			              Required="true" RequiredError="File cannot live without it's name!'"/>
			<MudTextField T="string" Label="Short info"
			              @bind-Value="@_formModel.Title"
			              Required="true" RequiredError="You must provide some information to identify file!'"/>

			<MudStack Row="true">
				<MudText>Category:</MudText>
				<MudText>@_formModel.CategoryName</MudText>
				<MudButton OnClick="ChangeFormFileCategory">Change</MudButton>
			</MudStack>
			
			<MudStack Row="true">
				<MudText>Author:</MudText>
				<MudText>@_formModel.AuthorName</MudText>
				<MudButton OnClick="ChangeFormFileAuthor">Change</MudButton>
			</MudStack>
			
			<MudText>ContentType: @_formModel.ContentType</MudText>
			<MudText>Size: @_formModel.Size</MudText>
			
			<MudButton OnClick="SaveFormData">Save</MudButton>
		</MudForm>   
	</MudDrawer>

	<div>
		<div>
			<InputFile id="fileInput" hidden OnChange="OnFilesListChange" accept="@ContentTypesState.Value.Filter" multiple />
			<MudButton HtmlTag="label" for="fileInput" Variant="Variant.Filled" Size="Size.Small">Add more</MudButton>
		</div>

		<TableView Data="State.Value.Files">
			<TableHeader>
				<MudTh>Name</MudTh>
				<MudTh>Category</MudTh>
				<MudTh>Size</MudTh>
				<MudTh>State</MudTh>
				<MudTh></MudTh>
			</TableHeader>

			<RowTemplate>
				<MudTd DataLabel="Name">@context.FileName</MudTd>
				<MudTd DataLabel="Category">@context.CategoryName</MudTd>
				<MudTd DataLabel="Size">@context.Size</MudTd>
				<MudTd DataLabel="State">@context.State</MudTd>
				<MudTd>
					<MudButton Variant="Variant.Filled" Size="Size.Small" OnClick="() => Details(context)">Details</MudButton>
					<MudButton Variant="Variant.Filled" Size="Size.Small" OnClick="() => Delete(context)">Delete</MudButton>
				</MudTd>
			</RowTemplate>
		</TableView>

		<div>
			<MudButton Variant="Variant.Filled" Size="Size.Small" Disabled="@_cantUploadFiles" OnClick="Upload">Upload</MudButton>
		</div>
	</div>
</MudDrawerContainer>

@code {
	private bool _cantUploadFiles = true;

	private UploadFileDetailsForm _formModel = UploadFileDetailsForm.Empty;
	private bool _openFileDetails;
	private bool _fileDetailsFormFilledCorrectly;
	private string[] _fileDetailsFormError = { };

	protected override void OnAfterRender(bool firstRender)
	{
		_cantUploadFiles = State.Value.Files.Length <= 0;
	}

	private void OnFilesListChange(InputFileChangeEventArgs e)
	{
		if (e.FileCount <= 0) return;

		Dispatcher.Dispatch(new RegisterMultipleFilesUpload(e.GetMultipleFiles()));
	}

	private void Upload()
	{
		var toUpload = State.Value.Files.Where(x => x.State == UploadState.NotScheduled).ToList();
		Dispatcher.Dispatch(new ScheduleFilesUpload(toUpload));
	}

	private void Delete(FileUploadState context)
	{
		Dispatcher.Dispatch(new DeleteFileUpload(context.Id));
	}

	private void Details(FileUploadState context)
	{
		_openFileDetails = true;
		_formModel = new UploadFileDetailsForm()
		{
			Id = context.Id,
			CategoryName = context.CategoryName,
			CategoryId = context.CategoryId,
			FileName = context.FileName,
			Size = context.Size,
			ContentType = context.ContentType,
			Title = context.Title,
			AuthorName = context.AuthorName,
			AuthorId = context.AuthorId
		};
	}

	private void CloseFileDetails()
	{
		_formModel = UploadFileDetailsForm.Empty;
		_openFileDetails = false;
	}

	private async Task ChangeFormFileCategory()
	{
		var reference = DialogService.Show<FilesCategoriesSelector>();
		var result = await reference.Result;
		if (result.Cancelled || result.Data is not TreeFileCategory category) return;
		_formModel.CategoryName = category.Name;
		_formModel.CategoryId = category.Id;
	}

	private void SaveFormData()
	{
		var formCopy = JsonSerializer.Deserialize<UploadFileDetailsForm>(JsonSerializer.Serialize(_formModel));
		Dispatcher.Dispatch(new UpdateFileStateFromEditForm(formCopy.Id, formCopy));
	}

	private async Task ChangeFormFileAuthor()
	{
		var reference = DialogService.Show<AuthorSelector>();
		var result = await reference.Result;
		if (result.Cancelled || result.Data is not AuthorState author) return;
		_formModel.AuthorName = author.Name;
		_formModel.AuthorId = author.Id;
	}

}
